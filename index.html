<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Gaming Aggregator — Orion Edition</title>
<style>
:root{
  --bg:#0E4B53; --card:#0E4B53; --muted:#94a3b8; --text:#e5e7eb; --accent:#4CB818; --danger:#ef4444; --line:#1f2937; --warn:#f59e0b; --info:#38bdf8; --vio:#a78bfa; --ok:#10b981;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
.container{max-width:1480px;margin:0 auto;padding:24px}
.header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap}
.h1{font-size:22px;font-weight:800}
.nav{display:flex;flex-wrap:wrap;gap:8px}
.btn{background:var(--accent);border:none;color:#ffffff;padding:8px 12px;border-radius:10px;font-weight:700;cursor:pointer}
.btn.secondary{background:#123a40;color:var(--text);border:1px solid #123a40}
.btn.warn{background:var(--warn);color:#ffffff}
.btn.danger{background:var(--danger);color:ffffff}
.btn.info{background:var(--info);color:#0b0f1a}
.btn.vio{background:var(--vio);color:#ffffff}
.card{background:var(--card);padding:16px;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.2);margin-top:12px}
.input, select, textarea{background:#123a40;border:1px solid #123a40;border-radius:10px;padding:8px 10px;color:var(--text)}
textarea{min-height:90px}
.label{font-size:12px;color:var(--muted)}
.row{display:flex;gap:10px;flex-wrap:wrap}
.grow{flex:1 1 240px}
.table{width:100%;border-collapse:collapse;margin-top:10px}
.table th,.table td{border-bottom:1px solid #123a40;padding:8px 10px;text-align:left;font-size:14px}
.kpi{display:grid;grid-template-columns:repeat(6,minmax(200px,1fr));gap:12px}
.kpi .item{background:#ffffff;border:1px solid #ffffff;color: #123a40;border-radius:12px;padding:20px 15px;position:relative;overflow:hidden}
.kpi .label{font-size:12px;color:var(--muted)}
.kpi .value{font-size:18px;font-weight:800;margin-top:6px}
.spark{position:absolute;right:6px;bottom:6px;opacity:.9}
.help{color:var(--muted);font-size:12px}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid #123a40;background:#123a40}
.footer{margin-top:24px;color:var(--muted);font-size:12px;text-align:center}
.link{color:#93c5fd;text-decoration:none}
.hidden{display:none}
pre{white-space:pre-wrap;word-break:break-word;background:#0b1220;border:1px solid #1f2937;padding:8px;border-radius:8px}
hr{border:none;border-top:1px solid #1f2937;margin:12px 0}
.pointer{cursor:pointer}
.tag{padding:2px 6px;border:1px solid var(--card);border-radius:8px;font-size:12px;background:var(--card);margin-right:6px}
.grid{display:grid;gap:12px}
.grid.api{grid-template-columns:repeat(4,minmax(220px,1fr))}
.api-card{border:1px solid #123a40;border-radius:12px;padding:12px;background:#123a40}
.api-card .title{font-weight:700}
.api-card .meta{font-size:12px;color:#94a3b8;margin:6px 0}
.api-card code{display:block;background:var(--card);border:1px solid var(--card);padding:8px;border-radius:8px;font-size:12px}
.pill{display:inline-block;border:1px dashed #475569;padding:2px 6px;border-radius:999px;font-size:12px;margin-right:6px}
select[multiple]{height:100px}
.mini-bar{height:8px;background:#123a40;border:1px solid #123a40;border-radius:8px;overflow:hidden}
.mini-bar>div{height:100%;background:var(--info)}
.section{display:grid;grid-template-columns:2fr 1fr;gap:12px}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="h1">Gaming Aggregator — <span style="color:#93c5fd">Orion Edition</span></div>
    <div class="nav" style="gap:6px;align-items:center">
      <span id="who" class="badge" style="
    
    border-radius: 10px;
    padding: 8px 10px;
    color: var(--text);">Role: —</span>
      <select id="roleSel" class="input">
        <option>ADMIN</option>
        <option>GRA</option>
        <option>GAMING_COMMISSION</option>
        <option>MOF</option>
        <option>OPERATOR</option>
      </select>
      <select id="opSel" class="input"></select>
      <button class="btn accent" onclick="switchPersona()">Switch</button>
      <button class="btn danger" onclick="resetData()">Reset Data</button>
    </div>
  </div>

  <div class="nav" id="tabs">
    <button class="btn secondary" onclick="tab('dash')">Dashboard</button>
    <button class="btn secondary" onclick="tab('operators')">Operators</button>
    <button class="btn secondary" onclick="tab('psp')">PSPs</button>
    <button class="btn secondary" onclick="tab('guin')">GUIN / GRA Connector</button>
    <button class="btn secondary" onclick="tab('tx')">Transactions</button>
    <button class="btn secondary" onclick="tab('tax')">Tax Bills</button>
    <button class="btn secondary" onclick="tab('settle')">Settlements</button>
    <button class="btn secondary" onclick="tab('fund')">Consolidated Fund</button>
    <button class="btn secondary" onclick="tab('recon')">Reconciliation</button>
    <button class="btn secondary" onclick="tab('portal')">Stakeholder Portal</button>
    <button class="btn secondary" onclick="tab('api')">API Library (100+)</button>
    <button class="btn secondary" onclick="tab('reports')">Reports</button>
    <button class="btn secondary" onclick="tab('settings')">Settings</button>
    <button class="btn secondary" onclick="tab('audit')">Audit</button>
  </div>

  <div id="dash" class="card"><h3>Executive Dashboard</h3><div class="kpi" id="kpi"></div>
    <div class="section">
      <div class="card"><h4>Activity & Compliance</h4>
        <table class="table" id="dashTable"><thead><tr><th>Operator</th><th>PSP</th><th>Betting Base (7d)</th><th>Tax (7d)</th><th>Pending</th><th>Risk</th></tr></thead><tbody></tbody></table>
      </div>
      <div>
        <div class="card"><h4>Distribution (7d)</h4>
          <div class="label">By Operator</div><div id="distOps"></div>
          <div class="label" style="margin-top:8px">By PSP</div><div id="distPSP"></div>
        </div>
        <div class="card" style="margin-top:12px"><h4>Queues</h4>
          <div class="row"><div class="grow"><div class="label">Recon Requests</div><div id="qRecon" class="value">—</div></div>
          <div class="grow"><div class="label">Settlements in Staging</div><div id="qSettle" class="value">—</div></div></div>
        </div>
      </div>
    </div>
    <div class="row" style="margin-top:12px"><button class="btn" onclick="seedMore()">Generate Random Activity</button><button class="btn secondary" onclick="refreshAll()">Refresh</button></div>
  </div>

  <div id="operators" class="card hidden"><h3>Operators</h3>
    <div class="row">
      <div class="grow"><div class="label">New Operator Name</div><input id="opName" class="input" placeholder="e.g., Premier Gaming Ltd"></div>
      <div class="grow"><div class="label">TIN</div><input id="opTin" class="input" placeholder="e.g., P1234567890"></div>
      <div class="grow"><div class="label">License Status</div><select id="opLicense" class="input"><option value="valid">valid</option><option value="suspended">suspended</option></select></div>
      <div class="grow"><div class="label">License Expiry</div><input id="opExpiry" class="input" placeholder="YYYY-MM-DD"></div>
      <div class="grow" style="align-self:end"><button class="btn" onclick="createOperator()">Create</button></div>
    </div>
    <div class="row">
      <div class="grow"><div class="label">Compliance Docs</div><textarea id="opDocs" class="input" placeholder="e.g., Cert of Inc., Tax Clearance, AML/KYC policy"></textarea></div>
      <div class="grow"><div class="label">Primary Contact</div><input id="opContact" class="input" placeholder="name + email + phone"><div class="label" style="margin-top:8px">KYC Level</div><select id="opKyc" class="input"><option>Standard</option><option>Enhanced</option></select></div>
    </div>
    <table class="table" id="opTable"><thead><tr><th>ID</th><th>Name</th><th>TIN</th><th>API Key</th><th>License</th><th>Expiry</th><th>SLA (30d)</th><th>PSP</th><th>Tax Pending</th><th>Tax Paid</th><th>Risk</th></tr></thead><tbody></tbody></table>
  </div>

  <div id="psp" class="card hidden"><h3>Payment Service Providers (PSP) — Onboarding</h3>
    <div class="row">
      <div class="grow"><div class="label">PSP Name</div><input id="pspName" class="input" placeholder="e.g., AdomiPay, FinSwitch, MoMoHub"></div>
      <div class="grow"><div class="label">Switch / BIN</div><input id="pspSwitch" class="input" placeholder="e.g., GH-SWITCH-01 or 5360-54xx"></div>
      <div class="grow"><div class="label">SLA Target</div><input id="pspSla" class="input" placeholder="99.90%"></div>
      <div class="grow"><div class="label">Status</div><select id="pspStatus" class="input"><option>pending</option><option>certification</option><option>active</option><option>suspended</option></select></div>
      <div class="grow" style="align-self:end"><button class="btn" onclick="createPSP()">Add PSP</button></div>
    </div>
    <div class="row">
      <div class="grow"><div class="label">Compliance Docs</div><textarea id="pspDocs" class="input" placeholder="PCI AoC, ISO 27001, DR Runbook, Fraud Policy"></textarea></div>
      <div class="grow"><div class="label">Technical Contact</div><input id="pspContact" class="input" placeholder="name + email + phone"></div>
    </div>
    <div class="row">
      <div class="grow"><div class="label">Map Operators to PSP</div><select id="pspMapOp" class="input"></select></div>
      <div class="grow"><div class="label">Select PSP</div><select id="pspMap" class="input"></select></div>
      <div class="grow" style="align-self:end"><button class="btn warn" onclick="assignPSP()">Assign PSP to Operator</button></div>
    </div>
    <table class="table" id="pspTable"><thead><tr><th>ID</th><th>Name</th><th>Switch/BIN</th><th>SLA Target</th><th>Status</th><th>Operators</th></tr></thead><tbody></tbody></table>
  </div>

  <div id="guin" class="card hidden"><h3>GUIN / GRA Connector — Company & Director Insights</h3>
    <div class="row">
      <div class="grow"><div class="label">Search by TIN or Company</div><input id="guinQuery" class="input" placeholder="e.g., P1234567890 or Premier Gaming"></div>
      <div class="grow" style="align-self:end"><button class="btn" onclick="guinLookup()">Lookup</button></div>
    </div>
    <div id="guinResult" class="card" style="margin-top:12px;display:none"></div>
    <div class="help">Simulated secure integration to GUIN/GRA. Production would use mTLS + OAuth, field-level consent, and complete audit trails.</div>
  </div>

  <div id="tx" class="card hidden"><h3>Transactions</h3>
    <div class="row">
      <div class="grow"><div class="label">Operator (by ID)</div><input id="txFilterOp" class="input" placeholder="blank = all"></div>
      <div class="grow"><div class="label">Type</div><select id="txFilterType" class="input"><option value="">(any)</option><option>WALLET_TOPUP</option><option>STAKE</option><option>PAYOUT</option><option>OTHER</option></select></div>
      <div class="grow" style="align-self:end"><button class="btn secondary" onclick="renderTx()">Apply Filters</button></div>
    </div>
    <table class="table" id="txTable"><thead><tr><th>ID</th><th>Op</th><th>Type</th><th>Amount</th><th>Betting?</th><th>Status</th><th>Created</th></tr></thead><tbody></tbody></table>
  </div>

  <div id="tax" class="card hidden"><h3>Tax Bills (Betting Tax)</h3>
    <table class="table" id="taxTable"><thead><tr><th>Bill ID</th><th>Op</th><th>Tx</th><th>Base</th><th>Tax</th><th>Status</th><th>Created</th></tr></thead><tbody></tbody></table>
  </div>

  <div id="settle" class="card hidden"><h3>Settlements (Staging) — before sweep to Consolidated Fund</h3>
    <div class="row">
      <div class="grow"><div class="label">Actions</div><button class="btn" style="margin-right:10px;" onclick="createSettlementsFromPending()">Create Settlements from ALL Pending Bills</button><button class="btn warn" onclick="sweepSettlements()">Sweep to Consolidated Fund</button></div>
      <div class="grow"></div>
    </div>
    <table class="table" id="settleTable"><thead><tr><th>Settle ID</th><th>Op</th><th>Amount</th><th>Ref Bills</th><th>Status</th><th>Created</th><th>Swept At</th></tr></thead><tbody></tbody></table>
  </div>

  <div id="fund" class="card hidden"><h3>Consolidated Fund</h3>
    <div class="row"><div class="grow"><span class="badge" id="ledgerHead">Ledger Head: —</span></div><div class="grow" style="text-align:right"><button class="btn secondary" onclick="renderFund()">Refresh</button></div></div>
    <table class="table" id="fundTable"><thead><tr><th>ID</th><th>Op</th><th>Direction</th><th>Amount</th><th>Ref Bills / Settlement</th><th>Created</th></tr></thead><tbody></tbody></table>
  </div>

  <div id="recon" class="card hidden"><h3>Reconciliation — Unused Wallet Top-ups</h3>
    <table class="table" id="reconTable"><thead><tr><th>Req ID</th><th>Op</th><th>Bill</th><th>Base</th><th>Tax</th><th>Status</th><th>Created</th></tr></thead><tbody></tbody></table>
  </div>

  <div id="portal" class="card hidden"><h3>Stakeholder Portal</h3><div id="portalContent"></div></div>

  <div id="api" class="card hidden"><h3>API Library — Payments, Regulators, GRA, Verification, Ghana.gov, Webhooks, Analytics</h3>
    <div class="row">
      <div class="grow"><div class="label">Search</div><input id="apiSearch" class="input" placeholder="e.g., momo, settlements, verify"></div>
      <div class="grow"><div class="label">Category</div><select id="apiCat" class="input"><option value="">(all)</option><option>Payments</option><option>Regulators</option><option>GRA</option><option>Verification</option><option>Ghana.gov</option><option>Webhooks</option><option>Analytics</option></select></div>
      <div class="grow"><div class="label">Auth</div><select id="apiAuth" class="input"><option value="">(any)</option><option>OAuth2</option><option>mTLS</option><option>API Key</option><option>HMAC</option></select></div>
      <div class="grow" style="align-self:end"><button class="btn secondary" onclick="renderAPI()">Apply</button><button class="btn vio" style="margin-left:10px;" onclick="genClient()">Generate Client SDK</button></div>
    </div>
    <div id="apiGrid" class="grid api" style="margin-top:12px"></div>
  </div>

  <div id="reports" class="card hidden"><h3>14-Day Overview & Risk</h3><div class="kpi" id="kpi2"></div>
    <h4>Daily Summary</h4><table class="table" id="repTable"><thead><tr><th>Date</th><th>#Tx</th><th>Gross</th><th>Betting Base</th><th>Tax</th><th>Non-tax Net</th></tr></thead><tbody></tbody></table>
  </div>

  <div id="settings" class="card hidden"><h3>Settings</h3>
    <div class="row">
      <div class="grow"><div class="label">Betting Tax Rate (bps)</div><input id="betBps" class="input" type="number" value="2000"></div>
      <div class="grow"><div class="label">Qualifies as Betting</div><select id="betQual" multiple size="4" class="input"><option value="WALLET_TOPUP" selected>WALLET_TOPUP</option><option value="STAKE">STAKE</option><option value="PAYOUT">PAYOUT</option><option value="OTHER">OTHER</option></select></div>
      <div class="grow" style="align-self:end"><button class="btn" onclick="saveSettings()">Save</button></div>
    </div>
  </div>

  <div id="audit" class="card hidden"><h3>Audit Logs</h3><table class="table" id="auditTable"><thead><tr><th>ID</th><th>Actor</th><th>Action</th><th>Target</th><th>Info</th><th>Created</th></tr></thead><tbody></tbody></table></div>

  <div class="footer">Orion Edition — demo only. powered by Access Link 
Adomi Group</div>
</div>

<script>
const storeKey="gaming_orion_v1";
function nowISO(){ return new Date().toISOString().slice(0,19).replace('T',' '); }
function uuid(){ return URL.createObjectURL(new Blob()).split('/').pop(); }
function round2(x){ return Math.round(x*100)/100; }
function randInt(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function shaDemo(msg){ let h=0; for(let i=0;i<msg.length;i++){ h=(h*31+msg.charCodeAt(i))>>>0; } return ("00000000"+h.toString(16)).slice(-8).repeat(4); }

function loadStore(){
  let s = localStorage.getItem(storeKey);
  if(!s){
    const init = {
      operators:[], psps:[], transactions:[], tax_bills:[],
      settlements:[], fund_ledger:[], recon:[],
      rules:{bet_bps:2000, betting_types:["WALLET_TOPUP"]},
      api_catalog:[], audit:[],
      seq:{op:1,psp:1,txn:1,bill:1,settle:1,fund:1,recon:1,audit:1}
    };
    const names=["Acme Bets","LuckyWin Gaming","Premier Gaming Ltd","Sunrise Lotto"];
    names.forEach(n=>{
      init.operators.push({
        id:init.seq.op++, name:n, api_key:uuid().replaceAll('-',''), active:true, created_at:nowISO(),
        license:"valid", expiry: new Date(Date.now()+randInt(30,900)*24*3600*1000).toISOString().slice(0,10),
        tin:"P"+randInt(100000000,999999999), kyc:"Standard",
        contact:`${n.split(' ')[0]} Contact <${n.split(' ')[0].toLowerCase()}@${n.toLowerCase().replace(/\\s+/g,'')}.gh> +233-20${randInt(1000000,9999999)}`,
        docs:"Cert of Inc.; Tax Clearance; AML Policy", psp_id:null, sla:(95+Math.random()*5).toFixed(2)+"%",
        guin:null, directors_list:[]
      });
    });
    ["AdomiPay","FinSwitch","MoMoHub","CardRail GH"].forEach(n=>{
      init.psps.push({ id:init.seq.psp++, name:n, switch_id:"GH-SW-"+randInt(10,99), bin:"53"+randInt(10,99)+"-54xx",
        sla_target:"99."+randInt(80,99)+"%", status: pick(["pending","certification","active"]),
        docs:"PCI AoC; DR Plan", contact:`${n} Tech <ops@${n.toLowerCase().replace(/\\s+/g,'')}.gh>`
      });
    });
    init.operators.forEach((op,i)=>{ op.psp_id = init.psps[i % init.psps.length].id; });
    const types=["WALLET_TOPUP","STAKE","PAYOUT","OTHER"];
    for(const op of init.operators){
      for(let i=0;i<120;i++){
        const t=pick(types); const amt=t==="PAYOUT"? randInt(20,600) : randInt(30,1200);
        const status=Math.random()<0.95?"SUCCESS":"FAILED";
        const d=new Date(Date.now() - randInt(0,20)*24*3600*1000 - randInt(0,23)*3600*1000 - randInt(0,59)*60*1000);
        const created_at=d.toISOString().slice(0,19).replace('T',' ');
        const id=init.seq.txn++;
        init.transactions.push({id,operator_id:op.id,type:t,amount:round2(amt),status,created_at});
        if(status==="SUCCESS" && init.rules.betting_types.includes(t)){
          const bill_id=init.seq.bill++; const tax=round2(amt*(init.rules.bet_bps/10000));
          init.tax_bills.push({id:bill_id,operator_id:op.id,tx_id:id,base:round2(amt),rate_bps:init.rules.bet_bps,amount:tax,status:"PENDING",created_at,settled_at:null});
        }
      }
    }
    const billsByOp = {};
    init.tax_bills.forEach(b=>{ if(b.status==="PENDING"){ (billsByOp[b.operator_id]=billsByOp[b.operator_id]||[]).push(b);} });
    Object.keys(billsByOp).forEach(opId=>{
      const list=billsByOp[opId].slice(0,10);
      if(list.length){
        const amount = round2(list.reduce((a,b)=>a+b.amount,0));
        const sid = init.seq.settle++;
        init.settlements.push({id:sid, operator_id:+opId, amount, ref_bill_ids:list.map(x=>x.id).join(","), status:"SWEPT", created_at:nowISO(), swept_at:nowISO()});
        const fid=init.seq.fund++;
        init.fund_ledger.push({id:fid, operator_id:+opId, direction:"IN", amount, ref: "SETTLE#"+sid, created_at:nowISO()});
        list.forEach(b=>{ b.status="PAID"; b.settled_at=nowISO(); });
      }
    });
    for(let k=0;k<6;k++){
      init.fund_ledger.push({id:init.seq.fund++, operator_id:pick(init.operators).id, direction:"OUT", amount:round2(randInt(50,500)), ref:"RECON#"+randInt(10,99), created_at:nowISO()});
    }
    const cats=["Payments","Regulators","GRA","Verification","Ghana.gov","Webhooks","Analytics"];
    const auths=["OAuth2","mTLS","API Key","HMAC"]; const verbs=["GET","POST","PUT","DELETE"];
    const nouns=['settlements','reconciliations','verifications','status','webhooks','batches','lookups','reports'];
    const ops=['settlement','reconcile','verify','status','callback','batch','lookup','report'];
    for(let i=1;i<=120;i++){
      const c=pick(cats), a=pick(auths), v=pick(verbs);
      const slug=c.toLowerCase().replace('.','').replace(' ','-');
      const name=`${c} / ${ops[i%ops.length]} ${i}`;
      const path=`/api/${slug}/v${1 + (i%3)}/${nouns[i%nouns.length]}`;
      const rps= randInt(50,200); const burst=randInt(200,1000);
      init.api_catalog.push({id:i, name, category:c, version:`v${1 + (i%3)}`, auth:a, method:v, path, rate:`${rps}/s burst ${burst}`, sla:`99.${randInt(80,99)}%`, sample:`${v} ${path}\nAuthorization: ${a} ...\nX-Idempotency-Key: ${uuid().slice(0,8)}\n\n{ "example": true }`});
    }
    const actions=["LOGIN","SEED_MORE","OPERATOR_CREATE","PSP_CREATE","PSP_ASSIGN","SETTINGS_UPDATE","GUIN_SYNC","FUND_BULK_PAY","SETTLEMENT_CREATE","SETTLEMENT_SWEEP","RECON_SUBMIT","RECON_APPROVE","RECON_REJECT"];
    for(let i=0;i<800;i++){
      init.audit.push({id:init.seq.audit++, actor:pick(["ADMIN","GRA","GAMING_COMMISSION","MOF","SYSTEM"]), action:pick(actions), target:"-", info:"-", created_at:new Date(Date.now()-randInt(0,25)*24*3600*1000 - randInt(0,23)*3600*1000).toISOString().slice(0,19).replace('T',' ')});
    }
    s = JSON.stringify(init);
    localStorage.setItem(storeKey, s);
  }
  return JSON.parse(localStorage.getItem(storeKey));
}
function saveStore(s){ localStorage.setItem(storeKey, JSON.stringify(s)); }

let state = loadStore();
let persona = {role:"ADMIN", opId: state.operators[0]?.id || null};

function audit(action, target, info){
  const id = state.seq.audit++;
  state.audit.unshift({id,actor:persona.role,action,target,info,created_at:nowISO()});
  saveStore(state);
}

function populateRoleControls(){
  document.getElementById("roleSel").value = persona.role;
  const sel=document.getElementById("opSel"); sel.innerHTML="";
  state.operators.forEach(op=>{ const o=document.createElement("option"); o.value=op.id; o.textContent=`#${op.id} ${op.name}`; sel.appendChild(o); });
  sel.value = persona.opId || state.operators[0]?.id || "";
  document.getElementById("who").textContent = `Role: ${persona.role}${persona.role==="OPERATOR"&&persona.opId? " (Op #"+persona.opId+")":""}`;
}
function switchPersona(){
  persona.role=document.getElementById("roleSel").value;
  persona.opId=parseInt(document.getElementById("opSel").value||state.operators[0]?.id||1,10);
  populateRoleControls(); refreshAll();
}
function tab(id){
  ["dash","operators","psp","guin","tx","tax","settle","fund","recon","portal","api","reports","settings","audit"].forEach(x=>{
    document.getElementById(x).classList.toggle("hidden", x!==id);
  });
  if(id==="operators") renderOperators();
  if(id==="psp") renderPSP();
  if(id==="tx") renderTx();
  if(id==="tax") renderTax();
  if(id==="settle") renderSettlements();
  if(id==="fund") renderFund();
  if(id==="recon") renderRecon();
  if(id==="portal") renderPortal();
  if(id==="api") renderAPI();
  if(id==="reports") renderReports();
  if(id==="settings") loadSettings();
  if(id==="audit") renderAudit();
}

function sparkSVG(values,width=120,height=36){
  if(values.length<2) return "";
  const min=Math.min(...values), max=Math.max(...values);
  const scaleX=(i)=> (i*(width-6))/(values.length-1) + 3;
  const scaleY=(v)=> { if(max===min) return height/2; return height - ((v-min)/(max-min))*(height-6) - 3; };
  let d="";
  values.forEach((v,i)=>{ d += (i===0?"M":"L")+scaleX(i)+","+scaleY(v)+" "; });
  return `<svg class="spark" width="${width}" height="${height}" viewBox="0 0 ${width} ${height}"><path d="${d}" fill="none" stroke="var(--card)" stroke-width="2"/><circle cx="${scaleX(values.length-1)}" cy="${scaleY(values[values.length-1])}" r="2" fill="var(--card)"/></svg>`;
}
function miniBar(label, pct){
  return `<div class="row" style="align-items:center;margin:6px 0"><div class="grow"><span class="label">${label}</span></div><div style="min-width:120px" class="mini-bar"><div style="width:${pct}%;"></div></div><span class="label" style="min-width:40px;text-align:right">${pct}%</span></div>`;
}

function createOperator(){
  const name=document.getElementById("opName").value.trim();
  if(!name) return;
  const id=state.seq.op++;
  state.operators.push({
    id, name, api_key:uuid().replaceAll('-',''), active:true, created_at:nowISO(),
    license:document.getElementById("opLicense").value || "valid",
    expiry:document.getElementById("opExpiry").value || new Date(Date.now()+365*24*3600*1000).toISOString().slice(0,10),
    tin:document.getElementById("opTin").value || "P"+randInt(100000000,999999999),
    kyc:document.getElementById("opKyc").value || "Standard",
    contact:document.getElementById("opContact").value || "",
    docs:document.getElementById("opDocs").value || "",
    psp_id:null, sla:(95+Math.random()*5).toFixed(2)+"%",
    guin:null, directors_list:[]
  });
  saveStore(state); audit("OPERATOR_CREATE", name, null);
  renderOperators(); populateRoleControls();
}
function opAgg(opId){
  const bills = state.tax_bills.filter(b=>b.operator_id===opId);
  const pending = round2(bills.filter(b=>b.status==="PENDING").reduce((a,b)=>a+b.amount,0));
  const paid = round2(bills.filter(b=>b.status==="PAID").reduce((a,b)=>a+b.amount,0));
  const risk = riskFor(opId).score;
  const psp = state.psps.find(p=>p.id=== (state.operators.find(o=>o.id===opId)||{}).psp_id );
  return {pending, paid, risk, pspName: psp? psp.name : "—"};
}
function riskFor(opId){
  const tx=state.transactions.filter(t=>t.operator_id===opId);
  const tops=tx.filter(t=>t.type==="WALLET_TOPUP"&&t.status==="SUCCESS");
  const stakes=tx.filter(t=>t.type==="STAKE"&&t.status==="SUCCESS");
  const payouts=tx.filter(t=>t.type==="PAYOUT"&&t.status==="SUCCESS");
  const declines=tx.filter(t=>t.status!=="SUCCESS");
  const unplayed=tops.filter(top=>!stakes.some(s=> new Date(s.created_at)>new Date(top.created_at) && (new Date(s.created_at)-new Date(top.created_at))<7*24*3600*1000 ));
  const unplayedPct=tops.length? Math.round(unplayed.length*100/tops.length):0;
  const ratio=stakes.length? round2(payouts.length/stakes.length):0;
  const declinePct=tx.length? Math.round(declines.length*100/tx.length):0;
  let score=0; if(unplayedPct>30) score+=2; else if(unplayedPct>15) score+=1; if(ratio<0.5||ratio>1.5) score+=1; if(declinePct>10) score+=1;
  return {unplayedPct,ratio,declinePct,score};
}
function renderOperators(){
  const tb=document.querySelector("#opTable tbody"); tb.innerHTML="";
  let ops = state.operators;
  if(persona.role==="OPERATOR"){ ops = ops.filter(o=>o.id===persona.opId); }
  ops.forEach(op=>{
    const agg=opAgg(op.id);
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${op.id}</td><td>${op.name}<div class="label">${op.contact||''}</div></td><td>${op.tin}</td><td>${op.api_key}</td><td>${op.license}</td><td>${op.expiry}</td><td>${op.sla}</td><td>${agg.pspName}</td><td>${agg.pending.toFixed(2)}</td><td>${agg.paid.toFixed(2)}</td><td>${agg.risk}</td>`;
    tb.appendChild(tr);
  });
}

function renderPSP(){
  const opSel=document.getElementById("pspMapOp"); opSel.innerHTML="";
  state.operators.forEach(o=>{ const e=document.createElement("option"); e.value=o.id; e.textContent=`#${o.id} ${o.name}`; opSel.appendChild(e); });
  const pspSel=document.getElementById("pspMap"); pspSel.innerHTML="";
  state.psps.forEach(p=>{ const e=document.createElement("option"); e.value=p.id; e.textContent=`#${p.id} ${p.name}`; pspSel.appendChild(e); });
  const tb=document.querySelector("#pspTable tbody"); tb.innerHTML="";
  let rows=state.psps;
  if(persona.role==="OPERATOR"){ rows = rows.filter(p=> state.operators.find(o=>o.id===persona.opId)?.psp_id === p.id ); }
  rows.forEach(psp=>{
    const ops=state.operators.filter(o=>o.psp_id===psp.id).map(o=>`#${o.id}`).join(", ");
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${psp.id}</td><td>${psp.name}</td><td>${psp.switch_id} / ${psp.bin}</td><td>${psp.sla_target}</td><td>${psp.status}</td><td>${ops||"—"}</td>`;
    tb.appendChild(tr);
  });
}
function createPSP(){
  const id=state.seq.psp++;
  state.psps.push({
    id, name:document.getElementById("pspName").value || ("PSP "+id),
    switch_id:document.getElementById("pspSwitch").value || ("GH-SW-"+randInt(10,99)),
    bin:document.getElementById("pspSwitch").value? "" : ("53"+randInt(10,99)+"-54xx"),
    sla_target:document.getElementById("pspSla").value || "99.90%",
    status:document.getElementById("pspStatus").value || "pending",
    docs:document.getElementById("pspDocs").value || "",
    contact:document.getElementById("pspContact").value || ""
  });
  saveStore(state); audit("PSP_CREATE", String(id), null);
  renderPSP();
}
function assignPSP(){
  const opId=parseInt(document.getElementById("pspMapOp").value,10);
  const pspId=parseInt(document.getElementById("pspMap").value,10);
  const op=state.operators.find(o=>o.id===opId);
  if(op){ op.psp_id=pspId; saveStore(state); audit("PSP_ASSIGN", `op=${opId}`, `psp=${pspId}`); renderPSP(); renderOperators(); }
}

function guinLookup(){
  const q=document.getElementById("guinQuery").value.trim().toLowerCase();
  const match = state.operators.find(o=>o.tin.toLowerCase()===q || o.name.toLowerCase().includes(q));
  const box=document.getElementById("guinResult");
  if(!match){
    box.style.display="block";
    box.innerHTML = `<div class="label">No exact record. You can still attach a GUIN profile to an operator.</div>
      <div class="row" style="margin-top:8px">
        <div class="grow"><div class="label">Attach to Operator</div>
          <select id="guinAttach" class="input">${state.operators.map(o=>`<option value="${o.id}">#${o.id} ${o.name}</option>`).join('')}</select>
        </div>
        <div class="grow">
          <div class="label">GUIN</div><input id="guinId" class="input" placeholder="GUIN-XXXXXXXX">
        </div>
        <div class="grow" style="align-self:end"><button class="btn warn" onclick="attachGUIN()">Attach</button></div>
      </div>`;
    return;
  }
  const guin = "GUIN-"+String(match.tin).slice(-8);
  const directors = Array.from({length: Math.max(2,Math.min(5, (match.name.length%5)+2))}).map((_,i)=>{
    const name = ["Ama","Kojo","Yaw","Kofi","Akosua","Esi","Kwame","Kwesi"][randInt(0,7)]+" "+["Mensah","Owusu","Boateng","Ofori","Asante","Addo"][randInt(0,5)];
    const tin = "P"+randInt(100000000,999999999);
    const role = pick(["Director","Secretary","Shareholder"]);
    const arrears = Math.random()<0.2 ? round2(randInt(500,5000)) : 0;
    const returns = pick(["On-time","Overdue 1m","Overdue 3m","Filed today"]);
    return {name,tin,role,arrears,returns};
  });
  const arrearsTotal = directors.reduce((a,b)=>a+(b.arrears||0),0);
  box.style.display="block";
  box.innerHTML = `
    <div class="row">
      <div class="grow"><span class="pill">Company</span><div class="h4">${match.name}</div></div>
      <div class="grow"><span class="pill">TIN</span><div>${match.tin}</div></div>
      <div class="grow"><span class="pill">GUIN</span><div>${guin}</div></div>
    </div>
    <div class="row" style="margin-top:8px">
      <div class="grow"><span class="pill">Directors</span><div>${directors.length}</div></div>
      <div class="grow"><span class="pill">Director Arrears (sum)</span><div>GHS ${arrearsTotal.toFixed(2)}</div></div>
      <div class="grow"><span class="pill">Company Risk</span><div>${arrearsTotal>2000?'HIGH':arrearsTotal>0?'MEDIUM':'LOW'}</div></div>
    </div>
    <h4 style="margin-top:10px">Director Details</h4>
    <table class="table">
      <thead><tr><th>Name</th><th>TIN</th><th>Role</th><th>Tax Arrears</th><th>Returns</th></tr></thead>
      <tbody>
        ${directors.map(d=>`<tr><td>${d.name}</td><td>${d.tin}</td><td>${d.role}</td><td>GHS ${d.arrears.toFixed(2)}</td><td>${d.returns}</td></tr>`).join('')}
      </tbody>
    </table>
    <div class="row" style="margin-top:8px">
      <button class="btn" onclick='syncGUIN(${match.id}, "${guin}", ${JSON.stringify(arrearsTotal)}, ${JSON.stringify(directors).replace(/"/g,'&quot;')})'>Sync to Operator</button>
    </div>
  `;
}
function attachGUIN(){
  const opId=parseInt(document.getElementById("guinAttach").value,10);
  const guin=document.getElementById("guinId").value || ("GUIN-"+uuid().slice(0,8));
  syncGUIN(opId, guin, 0, []);
}
function syncGUIN(opId, guin, directors_arrears, directors_list){
  const op=state.operators.find(o=>o.id===opId); if(!op) return;
  op.guin = guin; op.gra_arrears = directors_arrears||0; op.directors_list = directors_list||[];
  saveStore(state); audit("GUIN_SYNC", `op=${opId}`, `guin=${guin}`);
  document.getElementById("guinResult").innerHTML += `<div class="help" style="margin-top:8px">Synced to operator #${opId}.</div>`;
  renderOperators();
}

function renderTx(){
  const tb=document.querySelector("#txTable tbody"); tb.innerHTML="";
  let rows = state.transactions;
  if(persona.role==="OPERATOR") rows = rows.filter(r=>r.operator_id===persona.opId);
  const fop=document.getElementById("txFilterOp")? document.getElementById("txFilterOp").value.trim() : "";
  const ftype=document.getElementById("txFilterType")? document.getElementById("txFilterType").value.trim() : "";
  if(fop) rows = rows.filter(r=>String(r.operator_id)===fop);
  if(ftype) rows = rows.filter(r=>r.type===ftype);
  rows.slice(0,400).forEach(t=>{
    const betting = state.rules.betting_types.includes(t.type) ? "Yes":"No";
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${t.id}</td><td>${t.operator_id}</td><td>${t.type}</td><td>${t.amount.toFixed(2)}</td><td>${betting}</td><td>${t.status}</td><td>${t.created_at}</td>`;
    tb.appendChild(tr);
  });
}
function renderTax(){
  const tb=document.querySelector("#taxTable tbody"); tb.innerHTML="";
  let rows = state.tax_bills;
  if(persona.role==="OPERATOR") rows = rows.filter(r=>r.operator_id===persona.opId);
  rows.slice(0,500).forEach(b=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${b.id}</td><td>${b.operator_id}</td><td>${b.tx_id}</td><td>${b.base.toFixed(2)}</td><td>${b.amount.toFixed(2)}</td><td>${b.status}</td><td>${b.created_at}</td>`;
    tb.appendChild(tr);
  });
}

function createSettlementsFromPending(){
  const group={};
  state.tax_bills.filter(b=>b.status==="PENDING").forEach(b=>{ (group[b.operator_id]=group[b.operator_id]||[]).push(b); });
  for(const opId of Object.keys(group)){
    const list=group[opId]; const amt=round2(list.reduce((a,b)=>a+b.amount,0));
    if(amt<=0) continue;
    const sid=state.seq.settle++;
    state.settlements.unshift({id:sid, operator_id:+opId, amount:amt, ref_bill_ids:list.map(x=>x.id).join(","), status:"IN_QUEUE", created_at:nowISO(), swept_at:null});
    list.forEach(b=>{ b.status="PAID"; b.settled_at=nowISO(); });
    audit("SETTLEMENT_CREATE", `op=${opId}`, `amount=${amt}`);
  }
  saveStore(state);
  renderSettlements(); renderTax(); renderKPIs(); renderReports(); renderFund(); renderDashboardDist();
}
function sweepSettlements(){
  state.settlements.filter(s=>s.status==="IN_QUEUE").forEach(s=>{
    const fid=state.seq.fund++;
    state.fund_ledger.unshift({id:fid, operator_id:s.operator_id, direction:"IN", amount:s.amount, ref:"SETTLE#"+s.id, created_at:nowISO()});
    s.status="SWEPT"; s.swept_at=nowISO();
    audit("SETTLEMENT_SWEEP", `settle=${s.id}`, `amount=${s.amount}`);
  });
  saveStore(state);
  renderSettlements(); renderFund(); renderKPIs(); renderReports();
}
function ledgerHead(){
  const rows=[...state.fund_ledger].sort((a,b)=>a.id-b.id);
  let prev="GENESIS";
  for(const r of rows){ prev = shaDemo(prev + JSON.stringify({id:r.id,op:r.operator_id,dir:r.direction,amt:r.amount,ref:r.ref,ts:r.created_at})); }
  return prev.slice(0,16);
}
function renderSettlements(){
  const tb=document.querySelector("#settleTable tbody"); tb.innerHTML="";
  let rows=state.settlements;
  if(persona.role==="OPERATOR") rows = rows.filter(r=>r.operator_id===persona.opId);
  rows.slice(0,400).forEach(s=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${s.id}</td><td>${s.operator_id}</td><td>${s.amount.toFixed(2)}</td><td>${s.ref_bill_ids}</td><td>${s.status}</td><td>${s.created_at}</td><td>${s.swept_at||""}</td>`;
    tb.appendChild(tr);
  });
}
function renderFund(){
  const tb=document.querySelector("#fundTable tbody"); tb.innerHTML="";
  let rows = state.fund_ledger;
  if(persona.role==="OPERATOR") rows = rows.filter(r=>r.operator_id===persona.opId);
  rows.slice(0,400).forEach(f=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${f.id}</td><td>${f.operator_id}</td><td>${f.direction}</td><td>${f.amount.toFixed(2)}</td><td>${f.ref||""}</td><td>${f.created_at}</td>`;
    tb.appendChild(tr);
  });
  document.getElementById("ledgerHead").textContent = "Ledger Head: " + ledgerHead();
}

function findUnusedTopupBills(){
  const tops=state.transactions.filter(t=>t.type==="WALLET_TOPUP"&&t.status==="SUCCESS");
  const stakes=state.transactions.filter(t=>t.type==="STAKE"&&t.status==="SUCCESS");
  function isUnused(top){
    return !stakes.some(s=> s.operator_id===top.operator_id && new Date(s.created_at)>new Date(top.created_at) && (new Date(s.created_at)-new Date(top.created_at))<7*24*3600*1000 );
  }
  const unused=tops.filter(isUnused);
  return unused.map(top=> state.tax_bills.find(b=>b.tx_id===top.id)).filter(Boolean);
}
function renderRecon(){
  const tb=document.querySelector("#reconTable tbody"); tb.innerHTML="";
  let unused=findUnusedTopupBills();
  if(persona.role==="OPERATOR") unused = unused.filter(u=>u.operator_id===persona.opId);
  unused.slice(0,300).forEach(u=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>REQ-${u.id}</td><td>${u.operator_id}</td><td>${u.id}</td><td>${u.base.toFixed(2)}</td><td>${u.amount.toFixed(2)}</td><td>${u.status==="PAID"?"ELIGIBLE_REFUND":"CREDITABLE"}</td><td>${u.created_at}</td>`;
    tb.appendChild(tr);
  });
}

function renderAPI(){
  const grid=document.getElementById("apiGrid"); grid.innerHTML="";
  const q=(document.getElementById("apiSearch").value||"").toLowerCase();
  const cat=document.getElementById("apiCat").value;
  const auth=document.getElementById("apiAuth").value;
  let rows=state.api_catalog;
  if(q) rows=rows.filter(a=>a.name.toLowerCase().includes(q) || a.path.toLowerCase().includes(q));
  if(cat) rows=rows.filter(a=>a.category===cat);
  if(auth) rows=rows.filter(a=>a.auth===auth);
  rows.slice(0,120).forEach(a=>{
    const div=document.createElement("div");
    div.className="api-card";
    div.innerHTML = `
      <div class="title">${a.name}</div>
      <div class="meta">${a.category} • ${a.version} • Auth: ${a.auth} • SLA: ${a.sla} • Rate: ${a.rate}</div>
      <code>${a.sample}</code>
      <div style="margin-top:6px">
        <span class="tag">Method: ${a.method}</span><br>
      </div>

      <div style="margin-top:6px">
         <span class="tag">Path: ${a.path}</span>
          <button class="btn secondary" style="float:right" onclick="copyText(\`${a.sample.replace(/`/g,'\\`')}\`)">Copy Sample</button>
      </div>
    `;
    grid.appendChild(div);
  });
}
function copyText(t){ navigator.clipboard.writeText(t); alert("Copied sample to clipboard"); }
function genClient(){
  const lines = ["// Auto-generated SDK (TypeScript, demo)","export class GamingSDK {","  constructor(public baseUrl:string, public token:string){}"];
  state.api_catalog.slice(0,50).forEach(a=>{
    const fn = a.name.toLowerCase().replace(/[^a-z0-9]+/g,'_');
    lines.push(`  async ${fn}(payload:any){ return fetch(this.baseUrl+'${a.path}', {method:'${a.method}', headers:{'Authorization':'Bearer '+this.token,'Content-Type':'application/json'}, body: JSON.stringify(payload)}); }`);
  });
  lines.push("}");
  const blob = new Blob([lines.join("\n")], {type:"text/plain"});
  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download="gaming-sdk.ts"; a.click(); URL.revokeObjectURL(url);
}

function summarize(days=14){
  const end=new Date(); const out=[];
  for(let i=0;i<days;i++){
    const d=new Date(end.getTime()-i*24*3600*1000); const ds=d.toISOString().slice(0,10);
    let rows = state.transactions.filter(t=>t.status==="SUCCESS" && t.created_at.slice(0,10)===ds);
    if(persona.role==="OPERATOR") rows = rows.filter(r=>r.operator_id===persona.opId);
    const betRows = rows.filter(t=>state.rules.betting_types.includes(t.type));
    const c=rows.length, gross=rows.reduce((a,b)=>a+b.amount,0), base=betRows.reduce((a,b)=>a+b.amount,0);
    const tax=round2(base*(state.rules.bet_bps/10000)), net=round2(gross-tax);
    out.push({date:ds,total_transactions:c,total_gross:round2(gross),betting_base:round2(base),tax:round2(tax),non_tax_net:net});
  }
  return out.reverse();
}
function renderReports(){
  const rows=summarize(14);
  const base=round2(rows.reduce((a,b)=>a+b.betting_base,0));
  const tax=round2(rows.reduce((a,b)=>a+b.tax,0));
  document.getElementById("kpi2").innerHTML=`
    <div class="item"><div class="label">Betting Base (14d)</div><div class="value">GHS ${base.toFixed(2)}</div>${sparkSVG(rows.map(r=>r.betting_base))}</div>
    <div class="item"><div class="label">Computed Tax (14d)</div><div class="value">GHS ${tax.toFixed(2)}</div>${sparkSVG(rows.map(r=>r.tax))}</div>
  `;
  const tb=document.querySelector("#repTable tbody"); tb.innerHTML="";
  rows.forEach(r=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${r.date}</td><td>${r.total_transactions}</td><td>${r.total_gross.toFixed(2)}</td>
      <td>${r.betting_base.toFixed(2)}</td><td>${r.tax.toFixed(2)}</td><td>${r.non_tax_net.toFixed(2)}</td>`;
    tb.appendChild(tr);
  });
}
function loadSettings(){
  document.getElementById("betBps").value = state.rules.bet_bps || 2000;
  const sel=document.getElementById("betQual");
  for(const opt of sel.options){ opt.selected=(state.rules.betting_types||["WALLET_TOPUP"]).includes(opt.value); }
}
function saveSettings(){
  const bps=parseInt(document.getElementById("betBps").value||"2000",10);
  const sel=document.getElementById("betQual");
  const list=Array.from(sel.selectedOptions).map(o=>o.value);
  state.rules.bet_bps=bps; state.rules.betting_types=list.length?list:["WALLET_TOPUP"];
  saveStore(state); audit("SETTINGS_UPDATE","betting_rules",JSON.stringify(state.rules)); refreshAll();
}
function renderAudit(){
  const tb=document.querySelector("#auditTable tbody"); tb.innerHTML="";
  state.audit.slice(0,1000).forEach(a=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${a.id}</td><td>${a.actor}</td><td>${a.action}</td><td>${a.target||""}</td><td>${a.info||""}</td><td>${a.created_at}</td>`;
    tb.appendChild(tr);
  });
}

function renderDashboardDist(){
  const rows=summarize(7);
  const byOp={}; const byPSP={};
  const dayTx = state.transactions.filter(t=>t.status==="SUCCESS" && new Date(t.created_at) >= new Date(Date.now()-7*24*3600*1000));
  dayTx.forEach(t=>{
    const op=state.operators.find(o=>o.id===t.operator_id); if(!op) return;
    byOp[op.name]=(byOp[op.name]||0)+t.amount;
    const p=state.psps.find(p=>p.id===op.psp_id);
    byPSP[p? p.name : "—"]=(byPSP[p? p.name : "—"]||0)+t.amount;
  });
  const totalAmt = Object.values(byOp).reduce((a,b)=>a+b,0) || 1;
  const opsHTML = Object.entries(byOp).sort((a,b)=>b[1]-a[1]).slice(0,6).map(([k,v])=> miniBar(k, Math.round(v*100/totalAmt))).join("");
  const pspTotal = Object.values(byPSP).reduce((a,b)=>a+b,0) || 1;
  const pspHTML = Object.entries(byPSP).sort((a,b)=>b[1]-a[1]).slice(0,6).map(([k,v])=> miniBar(k, Math.round(v*100/pspTotal))).join("");
  document.getElementById("distOps").innerHTML = opsHTML || "<div class='label'>No data</div>";
  document.getElementById("distPSP").innerHTML = pspHTML || "<div class='label'>No data</div>";
}
function renderKPIs(){
  const rows=summarize(14);
  const last7=rows.slice(-7);
  const totalTx=last7.reduce((a,b)=>a+b.total_transactions,0);
  const gross=round2(last7.reduce((a,b)=>a+b.total_gross,0));
  const base=round2(last7.reduce((a,b)=>a+b.betting_base,0));
  const tax=round2(last7.reduce((a,b)=>a+b.tax,0));
  const pending=round2(state.tax_bills.filter(b=>b.status==="PENDING").reduce((a,b)=>a+b.amount,0));
  const inQueue=round2(state.settlements.filter(s=>s.status==="IN_QUEUE").reduce((a,b)=>a+b.amount,0));
  const netFund=round2(state.fund_ledger.reduce((a,b)=>a+(b.direction==='IN'?b.amount:-b.amount),0));
  const reconQ = findUnusedTopupBills().length;
  document.getElementById("kpi").innerHTML=`
    <div class="item"><div class="label">Transactions (7d)</div><div class="value">${totalTx}</div>${sparkSVG(rows.map(r=>r.total_transactions))}</div>
    <div class="item"><div class="label">Gross (7d)</div><div class="value">GHS ${gross.toFixed(2)}</div>${sparkSVG(rows.map(r=>r.total_gross))}</div>
    <div class="item"><div class="label">Betting Base (7d)</div><div class="value">GHS ${base.toFixed(2)}</div>${sparkSVG(rows.map(r=>r.betting_base))}</div>
    <div class="item"><div class="label">Tax (7d)</div><div class="value">GHS ${tax.toFixed(2)}</div>${sparkSVG(rows.map(r=>r.tax))}</div>
    <div class="item"><div class="label">Pending Bills</div><div class="value">GHS ${pending.toFixed(2)}</div>${sparkSVG([pending])}</div>
    <div class="item"><div class="label">Fund Net Position</div><div class="value">GHS ${netFund.toFixed(2)}</div>${sparkSVG([netFund])}</div>
  `;
  document.getElementById("qRecon").textContent = reconQ;
  document.getElementById("qSettle").textContent = "GHS "+inQueue.toFixed(2);
  const tb=document.querySelector("#dashTable tbody"); tb.innerHTML="";
  let ops = state.operators;
  if(persona.role==="OPERATOR"){ ops = ops.filter(o=>o.id===persona.opId); }
  ops.forEach(op=>{
    const start = new Date(Date.now()-7*24*3600*1000);
    const tx7 = state.transactions.filter(t=>t.operator_id===op.id && t.status==="SUCCESS" && new Date(t.created_at)>=start);
    const base7 = tx7.filter(t=>state.rules.betting_types.includes(t.type)).reduce((a,b)=>a+b.amount,0);
    const tax7 = round2(base7*(state.rules.bet_bps/10000));
    const agg = opAgg(op.id);
    const tr=document.createElement("tr");
    tr.innerHTML = `<td>${op.name}</td><td>${(state.psps.find(p=>p.id===op.psp_id)||{}).name||'—'}</td>
      <td>GHS ${round2(base7).toFixed(2)}</td><td>GHS ${tax7.toFixed(2)}</td><td>GHS ${agg.pending.toFixed(2)}</td><td>${agg.risk}</td>`;
    tb.appendChild(tr);
  });
  renderDashboardDist();
}

function portalCard(title, html){ return `<div class="card"><h4>${title}</h4>${html}</div>`; }
function sum(arr, key){ return arr.reduce((a,b)=>a+(+b[key]||0),0); }
function aging(bills){
  const now=new Date(); let a0=0,a1=0,a2=0;
  bills.forEach(b=>{ const age=(now-new Date(b.created_at))/(24*3600*1000); if(age<=7) a0+=b.amount; else if(age<=30) a1+=b.amount; else a2+=b.amount; });
  return {a0:round2(a0),a1:round2(a1),a2:round2(a2)};
}
function renderPortal(){
  const role=persona.role; let html="";
  if(role==="GRA"){
    const pending = state.tax_bills.filter(b=>b.status==="PENDING");
    const ag=aging(pending);
    html += portalCard("Tax Oversight", `
      <div class="kpi" style="grid-template-columns:repeat(4,1fr)">
        <div class="item"><div class="label">Pending Bills</div><div class="value">GHS ${round2(sum(pending,'amount')).toFixed(2)}</div></div>
        <div class="item"><div class="label">Settlements In Queue</div><div class="value">GHS ${round2(sum(state.settlements.filter(s=>s.status==='IN_QUEUE'),'amount')).toFixed(2)}</div></div>
        <div class="item"><div class="label">Paid To Date</div><div class="value">GHS ${round2(sum(state.tax_bills.filter(b=>b.status==='PAID'),'amount')).toFixed(2)}</div></div>
        <div class="item"><div class="label">Aging (0-7 / 8-30 / 30+)</div><div class="value">GHS ${ag.a0} / ${ag.a1} / ${ag.a2}</div></div>
      </div>
      <p class="help">Create settlements from pending bills, then MoF sweeps to the Consolidated Fund.</p>
      <button class="btn" onclick="tab('settle')">Open Settlements</button>
    `);
  } else if(role==="GAMING_COMMISSION"){
    html += portalCard("Compliance Registry", `<button class="btn secondary" onclick="tab('operators')">Open Operators</button>`);
  } else if(role==="MOF"){
    html += portalCard("Treasury View", `
      <div class="kpi" style="grid-template-columns:repeat(3,1fr)">
        <div class="item"><div class="label">Settlements in Queue</div><div class="value">GHS ${round2(sum(state.settlements.filter(s=>s.status==='IN_QUEUE'),'amount')).toFixed(2)}</div></div>
        <div class="item"><div class="label">Fund Net Position</div><div class="value">GHS ${round2(state.fund_ledger.reduce((a,b)=>a+(b.direction==='IN'?b.amount:-b.amount),0)).toFixed(2)}</div></div>
        <div class="item"><div class="label">Ledger Head</div><div class="value">${ledgerHead()}</div></div>
      </div>
      <button class="btn warn" onclick="tab('settle')">Sweep Settlements</button> <button class="btn secondary" onclick="tab('fund')">Open Fund Ledger</button>
    `);
  } else if(role==="OPERATOR"){
    const bills = state.tax_bills.filter(b=>b.operator_id===persona.opId);
    const paid = round2(sum(bills.filter(b=>b.status==='PAID'),'amount'));
    const pending = round2(sum(bills.filter(b=>b.status==='PENDING'),'amount'));
    const inqueue = round2(sum(state.settlements.filter(s=>s.operator_id===persona.opId && s.status==='IN_QUEUE'),'amount'));
    html += portalCard("Your Position", `
      <div class="kpi" style="grid-template-columns:repeat(4,1fr)">
        <div class="item"><div class="label">Pending</div><div class="value">GHS ${pending.toFixed(2)}</div></div>
        <div class="item"><div class="label">Settlements In Queue</div><div class="value">GHS ${inqueue.toFixed(2)}</div></div>
        <div class="item"><div class="label">Paid</div><div class="value">GHS ${paid.toFixed(2)}</div></div>
        <div class="item"><div class="label">Ledger Head</div><div class="value">${ledgerHead()}</div></div>
      </div>
      <div class="row" style="margin-top:8px"><button class="btn secondary" onclick="tab('tax')">View Bills</button> <button class="btn" onclick="tab('recon')">Reconcile</button></div>
    `);
  } else {
    html += `<p class="help">Switch role using the selector above.</p>`;
  }
  document.getElementById("portalContent").innerHTML = html;
}

function seedMore(){
  for(let i=0;i<60;i++){
    const op=pick(state.operators);
    const types=["WALLET_TOPUP","STAKE","PAYOUT","OTHER"];
    const type=pick(types); const amt= type==="PAYOUT"? randInt(20,600) : randInt(30,1200);
    const status=Math.random()<0.95?"SUCCESS":"FAILED"; const created_at=nowISO();
    const id=state.seq.txn++; state.transactions.unshift({id,operator_id:op.id,type,amount:round2(amt),status,created_at});
    if(status==="SUCCESS" && state.rules.betting_types.includes(type)){
      const bill_id=state.seq.bill++; const tax=round2(amt*(state.rules.bet_bps/10000));
      state.tax_bills.unshift({id:bill_id,operator_id:op.id,tx_id:id,base:round2(amt),rate_bps:state.rules.bet_bps,amount:tax,status:"PENDING",created_at,settled_at:null});
    }
  }
  saveStore(state); audit("SEED_MORE","", "60 new events"); refreshAll();
}
function refreshAll(){
  populateRoleControls();
  renderKPIs(); renderOperators(); renderPSP(); renderTx(); renderTax();
  renderSettlements(); renderFund(); renderRecon(); renderPortal(); renderAPI();
  renderReports(); renderAudit();
}
function resetData(){
  if(!confirm("Reset demo data?")) return;
  localStorage.removeItem(storeKey);
  state = loadStore(); audit("RESET","",null); refreshAll();
}

populateRoleControls(); tab("dash"); refreshAll();
</script>
</body>
</html>
